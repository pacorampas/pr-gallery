<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../pr-gallery-button/pr-gallery-button.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <pr-gallery></pr-gallery>

Example:

    <pr-gallery>
      <h2>Hello pr-gallery</h2>
    </pr-gallery>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="pr-gallery">
  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
      }

      div#wpCarousel {
        position: relative;
        overflow: hidden;
      }

      ul#carousel {
        width: 300%;
        margin: 0;
        padding: 0;
        list-style-type:none;
        white-space:nowrap;
        overflow-x: auto;
        font-size: 0;
        background: #333;
      }

      :host[transition-on] ul#carousel {
        transition: transform 0.2s;
      }

      li {
        float: left;
        position: relative;
        height: 400px;
        width: 100%;
        display: inline-block;
        text-align: center;
        font-size: 0;
        overflow: hidden;
        padding: 10px;
        box-sizing: border-box;
      }

      li:before {
        content: "";
        margin-left: -1px;
        width: 1px;
        height: 100%;
        display: inline-block;
        vertical-align: middle;
        opacity: 0;
      }

      img {
        max-width: 100%;
        max-height: 100%;
        display: inline-block;
        pointer-events: none;
        vertical-align: middle;
        -moz-user-select: none;
        -ms-user-select: none;
        -webkit-user-select: none;
        user-select: none;
      }

      #buttonPrev,
      #buttonNext {
        position: absolute;
        top: 50%;
        margin-top: -20px;
      }

      #buttonPrev {
        left: 10px;
      }
      #buttonNext {
        right: 10px;
      }
    </style>
    <div id="wpCarousel" class$="first-item-{{firstItem}} first-item-{{lastItem}}">
      <ul id="carousel" on-track="_handleTrack" style="width: {{widthCarousel}}%">
        <template
            id="images"
            is="dom-repeat"
            items="{{imagesActive}}"
            initial-count="1">
          <li style="width: {{width}}px">
            <img id="item-{{index}}" src="{{item.src}}">
          </li>
        </template>
      </ul>
      <pr-gallery-button
          id="buttonPrev"
          on-tap="prev"
          disabled="{{firstItem}}">
        Prev
      </pr-gallery-button>
      <pr-gallery-button
          id="buttonNext"
          on-tap="next"
          disabled="{{lastItem}}">
        Next
      </pr-gallery-button>
    </div>
  </template>

  <script>
    Polymer({
      is: 'pr-gallery',

      properties: {
        images: {
          type: Array
        },
        imagesActive: {
          type: Array,
          value: []
        },
        index: {
          type: Number,
          value: 0
        },
        width: {
          type: Number
        },
        widthCarousel: {
          type: Number
        },
        transitionOn: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },
        firstItem: {
          type: Boolean,
          value: false
        },
        lastItem: {
          type: Boolean,
          value: false
        }
      },

      _percentajeDisplacement: 0,

      ready: function() {
        this.firstItem = this._isFirstImage();
        this.lastItem = this._isLastImage();
        this._setImagesActive();
      },

      attached: function() {
        this.width = this.$.wpCarousel.offsetWidth;
      },

      next: function() {
        if (this._isLastImage()) {
          this.index = this.images.length-1;
          return;
        }

        this.index++;
        this._setImagesActive();
        var nextPoint = this.width*this.index;
        this._changeItems(nextPoint);
      },

      prev: function() {
        if (this._isFirstImage()) {
          this.index = 0;
          return;
        }

        this.index--;
        var prevPoint = this.width*this.index;
        this._changeItems(prevPoint);
      },

      _setImagesActive: function() {
        if (this.index === 0) {
          this.push('imagesActive', this.images[this.index]);
          this.push('imagesActive', this.images[this.index+1]);
        } else if (this._thereAreImagesNotActives() &&
            this._isTheLastPosition()) {
          //With each image the with should be 100% higher
          //The increment of 2 (this.index+2) is because the gallety start with
          //two images actives
          this.widthCarousel = (this.index+2)*100;
          this.push('imagesActive', this.images[this.index+1]);
        }
      },

      _changeItems: function(goTo, transitionOn) {
        this.firstItem = this._isFirstImage();
        this.lastItem = this._isLastImage();
        this.transitionOn = (transitionOn === false) ? false : true;
        this.translate3d('-'+goTo+'px', '0', '0', this.$.carousel);
      },

      _handleTrack: function(e) {
        switch(e.detail.state) {
          case 'track':
            var displacement = e.detail.dx;
            var actualPosition = this.width*this.index;
            var diff = actualPosition-displacement;
            _percentageDisplacement = displacement*100/this.width;

            //if is the last image is disable the drag to right (next image)
            if (!this._isLastImage() || _percentageDisplacement > 0) {
              this._changeItems(diff, false);
            }
            break;
          case 'end':
            //_percentajeDisplacement negative are to right or next image
            //_percentajeDisplacement positive are to left or prev image
            if (_percentageDisplacement < -15 && !this._isLastImage()) {
              this.next();
            } else if (_percentageDisplacement > 15
                && !this._isFirstImage()) {
              this.prev();
            } else {
              //return tu actual position
              this._changeItems(this.width*this.index);
            }
            break;
        }
      },

      _isLastImage: function() {
        return this.index >= this.images.length-1;
      },

      _isFirstImage: function() {
        return this.index <= 0;
      },

      _thereAreImagesNotActives: function() {
        return this.images.length > this.imagesActive.length;
      },

      _isTheLastPosition: function() {
        return this.index === this.imagesActive.length-1;
      }
    });
  </script>
</dom-module>
